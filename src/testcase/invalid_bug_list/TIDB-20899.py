import database.config as db_config
from testcase.helpers import DEFAULT_ISOLATION_LEVEL, IsolationLevel

ORIGINAL_ISOLATION_LEVEL = DEFAULT_ISOLATION_LEVEL
BUG_ID = "TIDB-20899"
LINK = "https://github.com/pingcap/tidb/issues/20899"
DB_AND_VERSION = db_config.DatabaseTypeAndVersion(db_config.DatabaseType.TIDB, "v4.0.8")

DESCRIPTION = """The update should block, but it doesn't."""

SETUP_SQL_SCRIPT = """
DROP TABLE IF EXISTS t;
CREATE TABLE `t` (`col_0` char(211) NOT NULL, `col_1` int(11) DEFAULT NULL, `col_2` timestamp NULL DEFAULT NULL, `col_3` int(11) NOT NULL, `col_4` tinyint(4) DEFAULT NULL, `col_5` varchar(362) NOT NULL, `col_6` date DEFAULT NULL, `col_7` date DEFAULT NULL, `col_8` varchar(315) NOT NULL, `col_9` char(184) DEFAULT NULL, `col_10` date NOT NULL, PRIMARY KEY (`col_0`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

INSERT INTO t VALUES("dazzling_nobel7", 539895813, "1993-11-21 01:08:25", 1984174257, -97, "elastic_pare6", "2233-12-12", "6608-12-20", "elated_bardeen5", "trusting_spence2", "2944-11-29"), ("boring_mccarthy9", -256662476, "1989-04-08 01:21:59", -1433347228, 88, "objective_curie4", "5327-02-08", "1078-05-27", "wizardly_bardeen3", "hardcore_albattani0", "5997-03-11"), ("admiring_hugle4", 244200099, "2033-10-26 06:46:43", -1909581650, 20, "cocky_bardeen1", "4356-05-02", "6385-06-29", "nostalgic_wiles0", "youthful_heisenberg3", "7355-08-06"), ("gracious_bell3", 917714001, "1980-12-25 08:42:47", 41220933, -53, "zealous_leavitt7", "6177-05-24", "7040-09-23", "eloquent_swanson7", "pensive_beaver2", "1236-06-18"), ("quirky_kilby3", 1322725985, "1972-12-11 04:44:22", 1034160028, 63, "ecstatic_tesla1", "3777-09-29", "6856-05-14", "trusting_almeida6", "suspicious_yonath7", "6672-12-20"), ("elated_wescoff0", -1094114262, "2021-05-04 03:08:38", 1658419520, 42, "lucid_sammet7", "2918-06-26", "5820-09-08", "cocky_brattain5", "festive_stallman6", "1003-07-26"), ("suspicious_yalow3", 1950630030, "2017-10-21 07:43:04", 1365059358, -59, "quirky_shannon2", "5458-02-08", "2132-07-18", "blissful_poincare2", "goofy_bohr8", "2915-06-03"), ("festive_goldberg7", -770450532, "2002-11-06 09:48:26", 1764693836, 86, "determined_murdock7", "8863-08-02", "4086-11-11", "nostalgic_wing6", "trusting_mccarthy4", "8459-05-02"), ("trusting_montalcini7", -1688646008, "1974-05-31 07:39:33", 207568759, 124, "compassionate_mcnulty6", "2554-05-10", "5112-12-31", "mystifying_noyce1", "zealous_bardeen0", "2013-09-24"), ("kind_rosalind5", 1185943781, "1999-09-11 20:10:45", -282379877, 101, "modest_franklin4", "4935-08-06", "4596-10-12", "vibrant_lamport2", "kind_swanson6", "4004-03-01");
INSERT INTO t VALUES("reverent_newton6", 908600411, "2015-10-15 02:02:47", 186382233, -25, "relaxed_swanson7", "9333-07-31", "4171-09-05", "ecstatic_swanson5", "stoic_yonath6", "3820-12-06"), ("wonderful_beaver0", 242920315, "2011-10-31 14:40:11", 1934108618, -79, "pedantic_pike0", "7541-11-07", "1675-12-09", "competent_kirch4", "eloquent_euler9", "8677-06-19"), ("unruffled_jennings4", 201046701, "1972-03-09 12:36:50", -881592412, -2, "youthful_hamilton6", "8965-02-01", "6245-10-07", "festive_shirley2", "kickass_darwin0", "1580-07-17"), ("eloquent_varahamihira3", -1948248542, "2032-06-17 15:28:17", 839319749, 15, "nervous_sammet0", "4006-03-15", "3962-10-06", "admiring_allen7", "kickass_wozniak4", "9544-08-24"), ("distracted_dijkstra9", -1730694250, "2015-03-06 08:27:54", 1054744029, 92, "practical_bardeen0", "9877-09-18", "3891-10-23", "competent_franklin1", "awesome_snyder4", "1171-02-27"), ("infallible_montalcini1", 737365637, "2025-04-18 01:33:44", 1464778649, 63, "distracted_brahmagupta3", "3494-09-10", "1767-01-24", "pensive_minsky1", "cranky_darwin8", "5874-02-06"), ("determined_cori1", 724357898, "2028-05-02 00:07:51", 1311310948, 91, "happy_visvesvaraya3", "8817-09-14", "8580-03-30", "laughing_pasteur9", "clever_bassi1", "8835-09-29"), ("kind_fermat7", -1539377315, "1978-09-28 05:27:02", 1571175918, 13, "laughing_mccarthy5", "7189-09-17", "4634-11-27", "ecstatic_northcutt1", "trusting_bhabha7", "2855-07-25"), ("naughty_hoover9", 1194058339, "2033-12-01 00:38:25", 1256763506, 59, "wonderful_swanson6", "9584-08-11", "7253-08-19", "clever_mclean9", "nervous_meninsky0", "6086-03-02"), ("gracious_mcnulty1", 857107021, "2024-03-01 01:46:22", -1133417383, 64, "goofy_keller0", "4399-04-24", "3618-01-09", "objective_euclid4", "admiring_ptolemy6", "8190-05-31");
INSERT INTO t VALUES("friendly_goldstine7", -1465925783, "2029-03-28 08:17:13", -119755107, -3, "awesome_joliot2", "5442-01-31", "1551-11-04", "clever_lalande4", "naughty_engelbart5", "7820-08-18"), ("dazzling_euclid6", -1556751580, "2029-08-17 05:06:52", 1848295678, 13, "brave_aryabhata0", "9917-01-04", "4239-08-18", "clever_hamilton2", "competent_thompson9", "3237-08-20"), ("cranky_knuth4", 1254096770, "1995-02-10 11:34:03", 37960317, 48, "jolly_edison3", "5245-01-30", "2671-10-18", "zen_leakey7", "infallible_kare0", "6914-07-03"), ("nifty_newton0", -1593741644, "2030-05-08 00:50:36", -266256525, 89, "optimistic_noether4", "4923-03-30", "1098-03-10", "cranky_cori4", "wonderful_spence5", "7295-04-28"), ("distracted_albattani9", -355479480, "2019-11-03 13:16:46", -1963832452, 126, "admiring_swanson9", "9295-01-14", "1745-04-16", "tender_franklin9", "festive_hodgkin8", "6158-01-22"), ("happy_albattani0", -1877500008, "2036-11-07 20:20:43", -418567172, 16, "confident_thompson6", "4494-05-17", "7457-08-19", "quirky_hodgkin3", "sad_wozniak2", "3636-09-14"), ("inspiring_mahavira8", 1311611577, "2001-01-22 14:46:48", -1493289412, 14, "condescending_mclean1", "3298-04-19", "1885-03-10", "affectionate_euclid1", "objective_mayer7", "5388-12-02"), ("goofy_goodall4", -1898427195, "2037-01-20 20:11:45", -1316182616, -18, "frosty_bhabha9", "6313-10-09", "7023-11-09", "sleepy_gates4", "wonderful_joliot9", "9658-06-19"), ("sleepy_kirch9", -1610361045, "2028-04-17 14:19:14", -795373350, 11, "naughty_mestorf7", "4561-12-07", "5246-12-27", "gallant_wilson7", "quirky_hoover3", "6826-10-06"), ("pensive_wilson3", 318848968, "2033-01-16 09:56:57", 1653224178, -21, "zen_lovelace2", "1730-12-26", "1356-12-04", "ecstatic_ptolemy9", "gallant_shockley9", "1181-11-20");
INSERT INTO t VALUES("compassionate_albattani5", -859925921, "2028-03-01 09:30:13", 407714885, -120, "gallant_lamarr8", "7599-02-28", "8032-12-05", "naughty_kare5", "nifty_hopper6", "9483-08-29"), ("silly_bohr6", -552288278, "2036-08-01 03:46:14", -1104652390, -38, "relaxed_ramanujan0", "9678-02-01", "6254-01-05", "priceless_aryabhata9", "zen_leavitt0", "8058-11-03"), ("flamboyant_knuth0", -1393106350, "1996-02-23 14:08:30", 2041305463, -62, "determined_liskov0", "6170-08-13", "7383-01-23", "ecstatic_lumiere1", "hopeful_austin4", "1269-02-15"), ("competent_cori8", 858747476, "1977-08-13 00:16:35", -1148457100, -33, "practical_kirch3", "4928-01-05", "1742-05-03", "fervent_archimedes4", "gifted_franklin4", "5140-07-12"), ("laughing_kirch1", -1536795165, "1998-05-05 14:55:45", 60731746, 40, "gifted_northcutt0", "6870-02-04", "6356-12-16", "affectionate_dijkstra9", "sleepy_chandrasekhar0", "2678-06-03"), ("festive_goodall3", -908520479, "2011-01-01 10:55:24", -1286372365, 13, "fervent_davinci3", "5547-11-17", "8901-02-19", "wonderful_ardinghelli8", "festive_mirzakhani5", "2549-03-20"), ("nervous_payne3", 133440765, "2015-09-30 09:28:46", -19954446, -81, "trusting_jones2", "5935-10-19", "8953-07-02", "optimistic_poitras5", "sleepy_mcclintock0", "6795-02-23"), ("priceless_hodgkin5", 1949117976, "1996-06-30 03:07:09", 3145939, 25, "relaxed_ptolemy6", "3166-04-22", "3347-02-05", "reverent_meitner3", "zen_visvesvaraya0", "8381-10-05"), ("sharp_boyd9", 1216404568, "2002-03-10 07:48:38", 1711067426, 89, "stoic_jepsen5", "5835-11-13", "3771-03-07", "dazzling_cray2", "hardcore_rosalind4", "1354-04-17"), ("goofy_spence4", 1490843963, "1992-12-17 07:17:46", 631629487, 96, "blissful_jepsen0", "4744-12-24", "8285-01-31", "adoring_fermi2", "ecstatic_poincare8", "9836-03-06");
INSERT INTO t VALUES("hardcore_tesla9", -117962729, "2035-09-04 13:27:37", 370034570, 81, "eager_mccarthy0", "8221-01-03", "4820-03-04", "condescending_goldberg2", "boring_banach2", "3618-05-05"), ("upbeat_turing4", 944746969, "2013-02-17 09:51:54", -157303637, 87, "elated_austin3", "2946-09-16", "3440-07-18", "wonderful_minsky8", "relaxed_mirzakhani0", "3849-02-01"), ("dazzling_hawking9", 110346069, "2004-09-11 16:15:21", -1625907153, 58, "determined_golick5", "2970-01-25", "5809-08-19", "vibrant_wiles6", "serene_kare1", "9462-06-05"), ("quizzical_ptolemy5", -1833219427, "2035-08-19 12:48:50", -1275172909, -85, "vibrant_perlman5", "6087-05-04", "5918-03-13", "serene_hopper6", "heuristic_wilson6", "8891-08-03"), ("loving_ptolemy9", -658056473, "2005-03-17 11:41:18", -666566475, -101, "zealous_goldberg7", "5895-08-30", "9220-10-19", "eager_mayer8", "practical_colden3", "8047-02-10"), ("brave_euclid0", -164340498, "1988-08-10 09:21:57", -2077016810, 35, "nostalgic_pike8", "3600-05-19", "5010-11-07", "ecstatic_banach2", "wonderful_dijkstra6", "4699-02-18"), ("frosty_torvalds3", -464983606, "1988-02-06 16:33:07", 1301224835, 76, "determined_kirch9", "3532-01-08", "1235-05-13", "jolly_snyder0", "pedantic_jones9", "9369-02-17"), ("zen_kalam5", -1287084318, "2020-01-04 21:48:18", -924784297, 51, "xenodochial_montalcini5", "7129-10-25", "1644-05-22", "inspiring_shockley6", "lucid_dubinsky5", "3073-05-26"), ("trusting_austin3", -1834194346, "1976-05-25 13:55:49", -1242610466, -93, "boring_wright9", "4596-08-17", "9839-11-22", "cranky_mestorf0", "quizzical_austin6", "2946-04-17"), ("wizardly_banach8", 2116482546, "2012-07-07 12:55:31", 1462290966, 119, "vibrant_tesla5", "9663-11-15", "9046-06-05", "naughty_darwin7", "confident_colden2", "3251-03-08");
INSERT INTO t VALUES("inspiring_golick7", 817095506, "1992-11-09 23:06:33", 2045684635, 53, "heuristic_kowalevski3", "4419-07-26", "1533-02-16", "awesome_lamport6", "thirsty_spence9", "3856-07-27"), ("boring_visvesvaraya1", 1387434398, "1987-08-06 01:39:03", -360371676, -4, "wizardly_cray5", "2437-09-15", "5183-01-21", "serene_bose9", "dreamy_haibt2", "4153-10-05"), ("nervous_kalam7", -62962874, "2017-04-20 00:09:34", 401392615, 10, "distracted_mayer9", "5853-05-25", "8256-03-10", "hungry_wing1", "eloquent_clarke5", "9056-04-04"), ("kind_beaver9", -1837221008, "2033-08-19 09:34:19", -1629816812, 36, "eloquent_nightingale2", "9179-05-23", "7745-02-13", "cocky_kilby4", "elegant_hypatia2", "2131-10-20"), ("admiring_edison6", 612417839, "2030-10-07 03:30:41", -144947301, 86, "trusting_nightingale5", "7269-11-25", "2672-11-15", "elastic_borg8", "amazing_galileo1", "2868-05-09"), ("peaceful_volhard1", -2098143618, "2030-08-24 13:10:53", 636173883, -33, "youthful_williams4", "6939-07-25", "7266-08-23", "gifted_jennings5", "stoic_hugle2", "7745-06-26"), ("dazzling_poincare5", 1281776927, "2012-06-17 14:35:55", -10410411, 105, "serene_cori6", "4164-01-27", "7779-04-10", "adoring_ramanujan4", "priceless_cray9", "1067-06-29"), ("upbeat_heisenberg2", -340448991, "2026-04-30 09:56:17", -1715980909, -27, "gracious_yonath6", "7356-10-03", "6966-03-31", "epic_lamport9", "agitated_minsky2", "9374-07-29"), ("hardcore_hugle8", 667160615, "1992-12-02 02:12:19", -1315288205, 125, "gallant_stallman7", "5680-08-22", "4821-02-08", "silly_bartik4", "eager_keller7", "6982-04-25"), ("tender_minsky7", 2089133212, "2036-09-19 10:14:19", -1327069034, 121, "lucid_morse3", "7313-11-19", "7492-09-16", "youthful_bohr2", "wizardly_archimedes6", "8184-03-15");
INSERT INTO t VALUES("elated_goodall8", -1612548846, "2014-12-29 04:21:29", 817795920, -35, "hardcore_poincare8", "4013-08-11", "8091-11-07", "awesome_wing7", "xenodochial_wiles0", "9833-09-03"), ("angry_wilson8", -968822612, "2030-09-14 16:59:14", -2028720218, -126, "happy_tesla3", "5392-08-28", "2373-07-05", "amazing_jang0", "affectionate_brattain5", "3857-05-04"), ("clever_stonebraker3", -2028650192, "1972-09-15 21:08:59", -1489842561, -13, "epic_yonath4", "8708-05-23", "4216-07-22", "kind_payne1", "flamboyant_kowalevski5", "2088-05-13"), ("agitated_meninsky5", -342893450, "1979-02-03 05:31:52", -1788476670, -70, "determined_yalow4", "7732-12-24", "6140-05-03", "hopeful_brown4", "heuristic_darwin3", "6950-05-16"), ("nifty_einstein2", -940356759, "1990-04-02 21:14:09", 1492051527, -16, "focused_dijkstra2", "3071-01-13", "3459-06-15", "zen_albattani8", "vibrant_tesla7", "5005-10-25"), ("tender_goldstine7", 1073560802, "1977-07-02 07:30:32", -489388053, 16, "jovial_almeida8", "1358-04-05", "7910-09-05", "nifty_colden4", "tender_curran5", "4097-10-04"), ("affectionate_mahavira0", -1599479712, "2004-02-18 11:10:13", 911591372, -66, "compassionate_agnesi4", "7737-12-08", "8218-07-22", "eloquent_franklin9", "lucid_minsky3", "3646-11-24"), ("confident_shirley3", 587064755, "2028-05-21 12:35:37", -1193527428, -59, "affectionate_newton8", "8997-03-02", "8947-12-17", "naughty_perlman7", "vibrant_elion2", "4393-09-17"), ("elastic_euclid4", -1590516963, "2020-11-26 09:53:09", -698494111, -62, "angry_fermi5", "4491-04-10", "7324-12-10", "quirky_archimedes0", "confident_meninsky8", "7204-07-09"), ("priceless_kare3", 2079208482, "1978-07-07 00:12:33", -1708464740, -78, "modest_heisenberg5", "8560-11-29", "8152-09-14", "thirsty_cray1", "pedantic_newton4", "7805-05-20");
INSERT INTO t VALUES("xenodochial_leavitt3", 2058017242, "2007-10-07 08:55:01", -765946141, 119, "festive_volhard4", "3200-08-10", "7031-08-08", "vibrant_carson9", "gallant_keller3", "3280-06-02"), ("sleepy_kowalevski1", -246341532, "1991-03-10 04:11:23", -942996472, 63, "serene_shockley9", "9823-01-03", "1430-07-27", "jovial_bohr1", "eloquent_banach6", "2733-07-07"), ("angry_curie0", 950650933, "2005-04-07 03:21:52", 1601876657, -10, "determined_volhard7", "4784-01-01", "8639-03-13", "youthful_curran5", "gifted_hypatia6", "7042-11-10"), ("awesome_panini4", -277273502, "2036-04-02 15:20:30", -1328323542, 0, "clever_williams1", "6184-10-02", "8905-06-30", "tender_jones5", "awesome_aryabhata7", "5550-08-09"), ("epic_colden2", 1465974354, "2009-07-29 02:10:08", -1240853949, -119, "pensive_kowalevski7", "6739-01-01", "3918-03-04", "reverent_liskov8", "hungry_bhaskara7", "8955-03-20"), ("gifted_meninsky8", -1133744126, "2037-04-30 03:23:13", 1113196807, -46, "loving_fermat3", "4587-08-25", "6988-06-13", "nifty_shaw3", "stupefied_meninsky5", "3381-04-16"), ("flamboyant_meninsky5", 1945987768, "1982-11-15 07:48:21", 1079576210, -79, "amazing_feynman3", "9711-11-15", "1778-09-11", "boring_banach1", "elegant_engelbart1", "1326-12-03"), ("stoic_wescoff2", 959307944, "2015-08-27 21:58:10", -1678519734, -93, "nervous_volhard0", "7763-12-20", "6273-03-08", "lucid_leavitt6", "kickass_roentgen7", "5554-09-25"), ("wonderful_aryabhata", 1348847059, "1994-04-08 12:02:11", -215796667, -78, "serene_agnesi3", "6458-05-04", "1704-09-28", "friendly_austin8", "flamboyant_noether8", "1381-02-27"), ("gracious_babbage6", 377597026, "1982-12-01 14:22:20", 1427784655, -88, "kind_ritchie3", "5444-01-07", "1129-03-14", "musing_brown4", "focused_jennings8", "7665-10-20");


"""


def get_scenarios(isolation_level: IsolationLevel):
    return [
        f"""
        conn_0> SET GLOBAL TRANSACTION ISOLATION LEVEL {isolation_level.value};
        conn_0> BEGIN;
        conn_1> CREATE INDEX k0 on t(`col_10`, `col_0`);
        conn_1> CREATE INDEX k1 on t(`col_2`, `col_3`);
        conn_2> ALTER TABLE t DROP INDEX k0;
        conn_1> CREATE INDEX k2 on t(`col_3`, `col_1`);
        conn_2> ALTER TABLE t DROP INDEX k1;
        conn_1> CREATE INDEX k3 on t(`col_1`, `col_0`);
        conn_2> ALTER TABLE t DROP INDEX k2;
        conn_1> CREATE INDEX k4 on t(`col_4`, `col_3`, `col_1`);
        conn_2> ALTER TABLE t DROP INDEX k3;
        conn_1> CREATE INDEX k5 on t(`col_4`, `col_10`);
        conn_2> ALTER TABLE t DROP INDEX k4;
        conn_1> CREATE INDEX k6 on t(`col_10`);
        conn_1> CREATE INDEX k7 on t(`col_9`, `col_8`, `col_7`);
        conn_1> CREATE INDEX k8 on t(`col_0`, `col_10`);
        conn_1> CREATE INDEX k9 on t(`col_2`, `col_1`);
        conn_0> SELECT SLEEP(1);
        conn_0> UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY), col_1=col_1/2 WHERE col_4<68;
        conn_0> UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY) WHERE col_3<-529739127;
        conn_0> UPDATE t SET col_0 = CONCAT(col_0, "-p"), col_8 = CONCAT(col_8, "-p") WHERE col_1<1951319788 AND col_5<"blissful_mcnulty6" AND col_9<"confident_fermat5" AND col_7<"8912-07-02";
        conn_0> UPDATE t SET col_10 = ADDDATE(col_10, INTERVAL 1 DAY), col_5 = CONCAT(col_5, "-p") WHERE col_7<"4430-01-24";
        conn_0> UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY) WHERE col_5<"sharp_euclid6" AND col_3<-1883486410;
        conn_0> UPDATE t SET col_5 = CONCAT(col_5, "-p"), col_7 = ADDDATE(col_7, INTERVAL 1 DAY) WHERE col_7<"6043-09-24" AND col_10<"7657-09-06" AND col_4<26;
        conn_0> UPDATE t SET col_4=col_4/2, col_7 = ADDDATE(col_7, INTERVAL 1 DAY), col_4=col_4/2 WHERE col_4<-121 AND col_3<-62203872 AND col_8<"gallant_minsky3";
        conn_0> UPDATE t SET col_8 = CONCAT(col_8, "-p"), col_2 = ADDDATE(col_2, INTERVAL 1 DAY) WHERE col_1<259276311 AND col_7<"9675-10-13" AND col_4<24;
        conn_0> UPDATE t SET col_3=col_3/2 WHERE col_10<"5930-08-21";
        conn_0> UPDATE t SET col_4=col_4/2, col_9 = CONCAT(col_9, "-p") WHERE col_5<"pedantic_agnesi7" AND col_7<"6992-10-20";
        conn_0> COMMIT;
        conn_3> ADMIN CHECK TABLE t;
        """,
    ]
